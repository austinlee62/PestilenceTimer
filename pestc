local INVALID_EVENTS = {
    SPELL_DISPEL            = true,
    SPELL_DISPEL_FAILED     = true,
    SPELL_STOLEN            = true,
    SPELL_AURA_REMOVED_DOSE = true,
    SPELL_AURA_BROKEN       = true,
    SPELL_AURA_BROKEN_SPELL = true,
    SPELL_CAST_FAILED       = true,
    SPELL_PERIODIC_HEAL     = true,
    SPELL_CAST_SUCCESS      = true,
}

local validSpellId = {
    [50842] = true,
}

local hexNoGUID = "0x0000000000000000"
local myGUID = UnitGUID("player")
local substr = string.sub
local stformat = string.format

local checkEpidemicRank = function()
    local name, iconPath, tier, column, currentRank, maxRank, isExceptional, meetsPrereq = GetTalentInfo(3, 5);
    return 15 + 3 * currentRank
end

local InitAura = function(allstates)
    
    if not checkDisease() then return; end
    local stateName = "Pest_Timer";
    allstates[stateName] = allstates[stateName] or {
        progressType = "timed",
        changed = true,
        autoHide = true,
        index = 0,
        icon = 136182,
    }
    allstates[stateName].duration = checkEpidemicRank();
    allstates[stateName].expirationTime = GetTime() + checkEpidemicRank();
    allstates[stateName].show = true;
    allstates[stateName].changed = true;
end


local OnCLEU = function(allstates, ...)
    local _, subEvent, _, sourceGUID, _,_, _, destGUID, _,_,_, spellId, spellName = ...
    if not subEvent then return end
    
    if INVALID_EVENTS[subEvent] then return end
    
    if substr(subEvent, 0, 6) ~= "SPELL_" then return end
    if ((destGUID == myGUID and ((not sourceGUID or sourceGUID == hexNoGUID) or sourceGUID == destGUID)) or sourceGUID == myGUID) then
        if subEvent == "SPELL_ENERGIZE" and validSpellId[spellId] then 
            InitAura(allstates)
        end
        
        return true
    end
    
end

aura_env.OnTrigger = function(allstates, event, ...)
    if event == "COMBAT_LOG_EVENT_UNFILTERED" then
        OnCLEU(allstates, ...)
    end

    return true
end

